<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>My gallery</title>

<style>
:root{
  --bg:#f6f8ff;
  --card:#ffffff;
  --text:#334155;
  --muted:#94a3b8;
  --line:#e5e7eb;

  /* Single pastel color */
  --accent:#93c5fd;        /* pastel blue */
  --accent-2:#bfdbfe;      /* lighter */
  --accent-text:#0b3a75;

  --radius:18px;
  --shadow: 0 10px 25px rgba(15, 23, 42, .08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 450px at 12% 12%, rgba(147,197,253,.35), transparent 60%),
    radial-gradient(900px 450px at 88% 20%, rgba(191,219,254,.35), transparent 60%),
    var(--bg);
  color:var(--text);
}

.container{max-width:1100px;margin:24px auto;padding:0 16px}
h1{margin:0;font-size:28px}
h2{margin:0 0 10px;font-size:16px}
.muted{color:var(--muted)}
.small{font-size:12px}

.header{
  display:flex;align-items:flex-end;justify-content:space-between;
  gap:12px;flex-wrap:wrap;margin-bottom:12px
}

.tabs{display:flex;gap:8px}
.tab{
  user-select:none;
  padding:10px 18px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.9);
  cursor:pointer;font-weight:900;
}
.tab.active{
  border:1px solid rgba(147,197,253,.65);
  background: rgba(147,197,253,.35);
  color: var(--accent-text);
}

.card{
  background:var(--card);
  border:1px solid rgba(148,163,184,.25);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  margin:14px 0;
}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
.field{display:flex;flex-direction:column;gap:6px;min-width:220px}
.field.grow{flex:1;min-width:260px}
label{font-size:12px;color:var(--muted)}

input,select{
  padding:12px 14px;border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  font-size:14px;
}

button{
  padding:12px 16px;border-radius:14px;border:1px solid rgba(147,197,253,.75);
  background: rgba(147,197,253,.35);
  color: var(--accent-text);
  font-weight:950;
  cursor:pointer;
}
button.secondary{
  background: rgba(191,219,254,.35);
  border:1px solid rgba(147,197,253,.55);
  color: var(--accent-text);
}
button.danger{
  background: rgba(147,197,253,.18);
  border:1px solid rgba(147,197,253,.55);
  color: #7a1d1d;
}
button:disabled{opacity:.6;cursor:not-allowed}

.panel.hidden{display:none}

/* Status box */
.status{
  border-radius:14px;
  border:1px solid rgba(147,197,253,.45);
  background: rgba(191,219,254,.18);
  padding:12px;
  white-space:pre-wrap;
}
.status.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08)}
.status.err{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08)}

/* Folder cards */
.foldersGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:14px;
}
.folderCard{
  border-radius:16px;
  overflow:hidden;
  background:#fff;
  border:1px solid var(--line);
  cursor:pointer;
  transition:transform .08s ease;
}
.folderCard:hover{transform:scale(1.01)}
.folderThumb{
  height:140px;
  background: rgba(191,219,254,.25);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.folderThumb img{width:100%;height:100%;object-fit:cover;display:block}
.folderThumb .ph{color:var(--muted);font-weight:900}
.folderMeta{
  padding:12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.folderName{font-weight:950;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.folderCount{
  font-size:12px;color:var(--muted);
  padding:4px 10px;border-radius:999px;border:1px solid var(--line);
  background:#f8fafc;
}
.folderRight{display:flex;gap:8px;align-items:center}

/* Dropzone */
.dropzone{
  margin-top:12px;
  padding:22px;
  border-radius:18px;
  border:2px dashed rgba(147,197,253,.85);
  text-align:center;
  background: rgba(191,219,254,.18);
}
.dropzone.drag{
  background: rgba(147,197,253,.18);
  border-color: rgba(96,165,250,.95);
}

/* Gallery inside folder view */
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:14px;margin-top:12px;
}
.thumb{
  border-radius:16px;
  overflow:hidden;
  background:#fff;
  border:1px solid var(--line);
}
.thumb img{width:100%;height:160px;object-fit:cover;display:block}
.meta{padding:12px;display:flex;flex-direction:column;gap:8px}
.metaTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
.fileName{font-weight:950;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.badge{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#f8fafc;
  color:var(--muted);
  white-space:nowrap;
}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{
  font-size:11px;padding:4px 10px;border-radius:999px;
  background: rgba(191,219,254,.35);
  border:1px solid rgba(147,197,253,.55);
  color: var(--accent-text);
}
.actions{display:flex;gap:8px}
.actions a, .actions button{
  flex:1;
  text-align:center;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(147,197,253,.55);
  background: rgba(191,219,254,.25);
  color: var(--accent-text);
  font-weight:950;
  text-decoration:none;
}
.actions button{cursor:pointer}

/* Top filters bar */
.filtersCard{
  margin-top:10px;
}
</style>
</head>

<body>
<div class="container">

  <header class="header">
    <div>
      <h1>My gallery</h1>
      <div class="muted small">IndexedDB • เก็บรูปเยอะขึ้น • Search = โชว์โฟลเดอร์อย่างเดียว</div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabSearch" role="button" tabindex="0">Search</div>
      <div class="tab" id="tabUpload" role="button" tabindex="0">Upload</div>
    </div>
  </header>

  <!-- Filters on TOP (always visible) -->
  <section class="card filtersCard" id="filtersTop">
    <h2>ค้นหา / ฟิลเตอร์</h2>
    <div class="row">
      <div class="field grow">
        <label>Search folder name</label>
        <input id="filterFolderName" placeholder="เช่น Trip, DC2, Running..." />
      </div>
      <div class="field grow">
        <label>Tags (คั่นด้วย , )</label>
        <input id="filterTags" placeholder="snow, family, invoice..." />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button class="secondary" id="btnClearFilters">Clear</button>
      </div>
    </div>
    <div class="muted small" id="topFilterInfo">—</div>
  </section>

  <!-- SEARCH (Folders only) -->
  <section class="panel" id="panelSearch">
    <!-- Folder List -->
    <section class="card" id="folderListCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Folders</h2>
        <div class="row" style="margin:0">
          <button class="secondary" id="btnResetAll" title="ลบข้อมูลทั้งหมดในเครื่องนี้">Reset All</button>
        </div>
      </div>
      <div id="foldersGrid" class="foldersGrid"></div>
      <div id="foldersEmpty" class="muted">ยังไม่มีโฟลเดอร์ — ไปที่แท็บ Upload เพื่อสร้างโฟลเดอร์</div>
    </section>

    <!-- Folder View (when click a folder) -->
    <section class="card hidden" id="folderViewCard">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h2 style="margin:0" id="currentFolderTitle">Folder</h2>
          <div class="muted small" id="currentFolderInfo">—</div>
        </div>
        <div class="row" style="margin:0">
          <button class="secondary" id="btnBackToFolders">Back</button>
          <button class="danger" id="btnDeleteFolder">Delete folder</button>
        </div>
      </div>

      <div id="folderGallery" class="gallery"></div>
      <div id="folderGalleryEmpty" class="muted">โฟลเดอร์นี้ยังไม่มีรูป</div>
    </section>
  </section>

  <!-- UPLOAD -->
  <section class="panel hidden" id="panelUpload">

    <!-- Status ONLY in Upload tab -->
    <section class="card">
      <h2>Status</h2>
      <div id="statusBox" class="status">กำลังเริ่มระบบ...</div>
      <div class="muted small" id="usageInfo">—</div>
    </section>

    <section class="card">
      <h2>สร้างโฟลเดอร์</h2>
      <div class="row">
        <div class="field grow">
          <label>New folder name</label>
          <input id="newFolderName" placeholder="เช่น Trip-Hokkaido / DC2 / Running" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="btnCreateFolder">Create</button>
        </div>
      </div>
      <div class="muted small">* Default ลบไม่ได้</div>
    </section>

    <section class="card">
      <h2>อัปโหลดรูป</h2>
      <div class="row">
        <div class="field">
          <label>Upload folder</label>
          <select id="uploadFolder"></select>
        </div>
        <div class="field grow">
          <label>Tags (ใช้กับรูปที่อัปโหลดรอบนี้)</label>
          <input id="uploadTags" placeholder="invoice, snow, family (คั่นด้วย , )" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="secondary" id="btnChoose">Choose images</button>
          <input type="file" id="fileInput" accept="image/*" multiple hidden />
        </div>
      </div>

      <div id="dropzone" class="dropzone">
        <div style="font-weight:950">ลากไฟล์รูปมาวางที่นี่ (Drag & Drop)</div>
        <div class="muted small">iPhone อาจไม่รองรับ Drag&Drop → ใช้ Choose images</div>
      </div>

      <div class="muted small" id="uploadMsg">—</div>
    </section>
  </section>

</div>

<script>
/* =========================================================
   IndexedDB Model
========================================================= */
const DB_NAME = "my_gallery_db_v1";
const DB_VERSION = 1;

const STORE_FOLDERS = "folders";
const STORE_IMAGES  = "images";

const $ = (id) => document.getElementById(id);

function setStatus(msg, type="") {
  // status exists only on upload tab; guard
  const box = $("statusBox");
  if (!box) return;
  box.className = "status" + (type ? " " + type : "");
  box.textContent = msg;
  console.log("[STATUS]", msg);
}

function uid() {
  return Date.now().toString(16) + "_" + Math.random().toString(16).slice(2);
}

function normalizeTags(str) {
  return String(str || "")
    .split(",")
    .map(t => t.trim())
    .filter(Boolean)
    .map(t => t.toLowerCase());
}

function sanitizeFolderName(name) {
  return String(name || "")
    .trim()
    .replace(/[\/\\]/g, "-")
    .replace(/(\.\.)/g, "")
    .replace(/[^\wก-๙\s.-]/g, "")
    .trim();
}

let db;
let currentFolder = null;

/* -------------------------
   IndexedDB helpers
------------------------- */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => reject(req.error);
    req.onupgradeneeded = () => {
      const d = req.result;

      if (!d.objectStoreNames.contains(STORE_FOLDERS)) {
        d.createObjectStore(STORE_FOLDERS, { keyPath: "name" });
      }

      if (!d.objectStoreNames.contains(STORE_IMAGES)) {
        const s = d.createObjectStore(STORE_IMAGES, { keyPath: "id" });
        s.createIndex("by_folder", "folder", { unique: false });
        s.createIndex("by_createdAt", "createdAt", { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
  });
}

function tx(storeNames, mode="readonly") {
  return db.transaction(storeNames, mode);
}

function idbPut(store, value) {
  return new Promise((resolve, reject) => {
    const r = store.put(value);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
function idbAdd(store, value) {
  return new Promise((resolve, reject) => {
    const r = store.add(value);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
function idbGet(store, key) {
  return new Promise((resolve, reject) => {
    const r = store.get(key);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
function idbDel(store, key) {
  return new Promise((resolve, reject) => {
    const r = store.delete(key);
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}
function idbGetAll(store) {
  return new Promise((resolve, reject) => {
    const r = store.getAll();
    r.onsuccess = () => resolve(r.result || []);
    r.onerror = () => reject(r.error);
  });
}
function idbClear(store) {
  return new Promise((resolve, reject) => {
    const r = store.clear();
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}
function idbGetAllByIndex(index, key) {
  return new Promise((resolve, reject) => {
    const r = index.getAll(key);
    r.onsuccess = () => resolve(r.result || []);
    r.onerror = () => reject(r.error);
  });
}

async function listFolders() {
  const t = tx([STORE_FOLDERS], "readonly");
  const store = t.objectStore(STORE_FOLDERS);
  const all = await idbGetAll(store);
  return all.map(x => x.name).sort((a,b)=>a.localeCompare(b));
}

async function ensureDefaultFolder() {
  const t = tx([STORE_FOLDERS], "readwrite");
  const store = t.objectStore(STORE_FOLDERS);
  const existing = await idbGet(store, "Default");
  if (!existing) await idbPut(store, { name: "Default" });
  await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });
}

async function deleteImagesInFolder(folder) {
  const t = tx([STORE_IMAGES], "readwrite");
  const store = t.objectStore(STORE_IMAGES);
  const idx = store.index("by_folder");
  const images = await idbGetAllByIndex(idx, folder);
  for (const img of images) await idbDel(store, img.id);
  await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });
}

async function getFolderStats() {
  const folders = await listFolders();
  const stats = {};
  for (const f of folders) stats[f] = { count: 0, coverId: null, coverCreatedAt: 0, tagSet: new Set() };

  const t = tx([STORE_IMAGES], "readonly");
  const store = t.objectStore(STORE_IMAGES);
  const all = await idbGetAll(store);

  for (const img of all) {
    if (!stats[img.folder]) stats[img.folder] = { count: 0, coverId: null, coverCreatedAt: 0, tagSet: new Set() };
    stats[img.folder].count++;
    (img.tags || []).forEach(tag => stats[img.folder].tagSet.add(String(tag).toLowerCase()));
    if ((img.createdAt||0) > (stats[img.folder].coverCreatedAt||0)) {
      stats[img.folder].coverCreatedAt = img.createdAt||0;
      stats[img.folder].coverId = img.id;
    }
  }
  return stats;
}

function setActiveTab(tab) {
  const isSearch = tab === "search";
  $("tabSearch").classList.toggle("active", isSearch);
  $("tabUpload").classList.toggle("active", !isSearch);
  $("panelSearch").classList.toggle("hidden", !isSearch);
  $("panelUpload").classList.toggle("hidden", isSearch);
}
$("tabSearch").addEventListener("click", () => setActiveTab("search"));
$("tabUpload").addEventListener("click", () => setActiveTab("upload"));

/* -------------------------
   Top filters (folders only)
------------------------- */
function folderMatchesFilters(folderName, stats, qName, qTags) {
  if (qName) {
    if (!folderName.toLowerCase().includes(qName)) return false;
  }
  if (qTags.length) {
    const tagSet = stats?.tagSet || new Set();
    for (const t of qTags) {
      if (!tagSet.has(t)) return false;
    }
  }
  return true;
}

/* -------------------------
   Render folder list only (Search main)
------------------------- */
async function blobToObjectURL(blob) {
  return URL.createObjectURL(blob);
}

async function renderFolderList() {
  const grid = $("foldersGrid");
  const empty = $("foldersEmpty");
  grid.innerHTML = "";

  const qName = ($("filterFolderName").value || "").trim().toLowerCase();
  const qTags = normalizeTags($("filterTags").value);

  const folders = await listFolders();
  if (!folders.length) {
    empty.style.display = "block";
    $("topFilterInfo").textContent = "—";
    return;
  }
  empty.style.display = "none";

  const stats = await getFolderStats();
  const filtered = folders.filter(f => folderMatchesFilters(f, stats[f], qName, qTags));

  $("topFilterInfo").textContent =
    `Folders: ${filtered.length} / ${folders.length}` +
    (qTags.length ? ` • tag filter: ${qTags.join(", ")}` : "");

  for (const f of filtered) {
    const count = stats[f]?.count ?? 0;
    const coverId = stats[f]?.coverId ?? null;

    const card = document.createElement("div");
    card.className = "folderCard";

    const thumb = document.createElement("div");
    thumb.className = "folderThumb";

    if (coverId) {
      const t = tx([STORE_IMAGES], "readonly");
      const store = t.objectStore(STORE_IMAGES);
      const cover = await idbGet(store, coverId);
      if (cover?.blob) {
        const img = document.createElement("img");
        img.loading = "lazy";
        img.alt = f;
        img.src = await blobToObjectURL(cover.blob);
        thumb.appendChild(img);
        img.onload = () => URL.revokeObjectURL(img.src);
      } else {
        const ph = document.createElement("div");
        ph.className = "ph";
        ph.textContent = "No image";
        thumb.appendChild(ph);
      }
    } else {
      const ph = document.createElement("div");
      ph.className = "ph";
      ph.textContent = "No image";
      thumb.appendChild(ph);
    }

    const meta = document.createElement("div");
    meta.className = "folderMeta";

    const name = document.createElement("div");
    name.className = "folderName";
    name.textContent = f;
    name.title = f;

    const right = document.createElement("div");
    right.className = "folderRight";

    const badge = document.createElement("div");
    badge.className = "folderCount";
    badge.textContent = `${count}`;

    right.appendChild(badge);

    meta.appendChild(name);
    meta.appendChild(right);

    card.appendChild(thumb);
    card.appendChild(meta);

    card.addEventListener("click", async () => {
      await openFolderView(f);
    });

    grid.appendChild(card);
  }
}

/* -------------------------
   Folder View (inside Search tab)
------------------------- */
async function openFolderView(folderName) {
  currentFolder = folderName;

  $("folderListCard").classList.add("hidden");
  $("folderViewCard").classList.remove("hidden");

  $("currentFolderTitle").textContent = `Folder: ${folderName}`;
  await renderFolderGallery(folderName);
}

$("btnBackToFolders").addEventListener("click", async () => {
  currentFolder = null;
  $("folderViewCard").classList.add("hidden");
  $("folderListCard").classList.remove("hidden");
  await renderFolderList();
});

$("btnDeleteFolder").addEventListener("click", async () => {
  if (!currentFolder) return;
  if (currentFolder === "Default") {
    alert('ไม่อนุญาตให้ลบโฟลเดอร์ "Default"');
    return;
  }
  if (!confirm(`ลบโฟลเดอร์ "${currentFolder}" และรูปทั้งหมดในโฟลเดอร์นี้?`)) return;

  try {
    await deleteImagesInFolder(currentFolder);
    const t = tx([STORE_FOLDERS], "readwrite");
    const store = t.objectStore(STORE_FOLDERS);
    await idbDel(store, currentFolder);
    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    currentFolder = null;
    $("folderViewCard").classList.add("hidden");
    $("folderListCard").classList.remove("hidden");
    await refillUploadFolderSelect();
    await renderFolderList();
  } catch (e) {
    alert(`ลบโฟลเดอร์ไม่สำเร็จ: ${e?.message || e}`);
  }
});

async function renderFolderGallery(folderName) {
  const gallery = $("folderGallery");
  const empty = $("folderGalleryEmpty");
  gallery.innerHTML = "";

  const t = tx([STORE_IMAGES], "readonly");
  const store = t.objectStore(STORE_IMAGES);
  const idx = store.index("by_folder");
  const images = await idbGetAllByIndex(idx, folderName);
  images.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));

  $("currentFolderInfo").textContent = `${images.length} images`;

  if (!images.length) {
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  for (const img of images) {
    const card = document.createElement("div");
    card.className = "thumb";

    const imageEl = document.createElement("img");
    imageEl.alt = img.name || "image";
    imageEl.loading = "lazy";
    const url = URL.createObjectURL(img.blob);
    imageEl.src = url;
    imageEl.onload = () => URL.revokeObjectURL(url);

    const meta = document.createElement("div");
    meta.className = "meta";

    const top = document.createElement("div");
    top.className = "metaTop";

    const name = document.createElement("div");
    name.className = "fileName";
    name.textContent = img.name || "(no name)";
    name.title = img.name || "";

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = folderName;

    top.appendChild(name);
    top.appendChild(badge);

    const tagsWrap = document.createElement("div");
    tagsWrap.className = "tags";
    (img.tags || []).forEach(tg => {
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = tg;
      tagsWrap.appendChild(tag);
    });

    const actions = document.createElement("div");
    actions.className = "actions";

    const dl = document.createElement("a");
    dl.href = "#";
    dl.textContent = "Download";
    dl.addEventListener("click", (e) => {
      e.preventDefault();
      const u = URL.createObjectURL(img.blob);
      const a = document.createElement("a");
      a.href = u;
      a.download = img.name || "image";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(u), 1000);
    });

    const del = document.createElement("button");
    del.textContent = "Delete";
    del.addEventListener("click", async () => {
      if (!confirm("ลบรูปนี้ออกจากเครื่องนี้?")) return;
      try {
        const t = tx([STORE_IMAGES], "readwrite");
        const store = t.objectStore(STORE_IMAGES);
        await idbDel(store, img.id);
        await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

        await renderFolderGallery(folderName);
        // refresh folder list counts/cover in background
      } catch (e) {
        alert(`ลบรูปไม่สำเร็จ: ${e?.message || e}`);
      }
    });

    actions.appendChild(dl);
    actions.appendChild(del);

    meta.appendChild(top);
    if ((img.tags || []).length) meta.appendChild(tagsWrap);
    meta.appendChild(actions);

    card.appendChild(imageEl);
    card.appendChild(meta);
    gallery.appendChild(card);
  }
}

/* -------------------------
   Upload tab: folders select + create/upload
------------------------- */
async function refillUploadFolderSelect() {
  const folders = await listFolders();
  const up = $("uploadFolder");
  up.innerHTML = "";
  folders.forEach(f => {
    const o=document.createElement("option");
    o.value=f; o.textContent=f;
    up.appendChild(o);
  });
  if (!up.value && folders.length) up.value = folders[0];
}

$("btnCreateFolder").addEventListener("click", async () => {
  try {
    const name = sanitizeFolderName($("newFolderName").value);
    if (!name) return setStatus("กรุณาใส่ชื่อโฟลเดอร์", "err");

    const folders = await listFolders();
    if (folders.includes(name)) return setStatus("มีโฟลเดอร์นี้อยู่แล้ว", "err");

    const t = tx([STORE_FOLDERS], "readwrite");
    const store = t.objectStore(STORE_FOLDERS);
    await idbPut(store, { name });

    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    $("newFolderName").value = "";
    await refillUploadFolderSelect();
    await renderFolderList();
    await updateUsageInfo();

    $("uploadFolder").value = name;
    setStatus(`สร้างโฟลเดอร์สำเร็จ: ${name}`, "ok");
  } catch (e) {
    setStatus(`สร้างโฟลเดอร์ไม่สำเร็จ: ${e?.message || e}`, "err");
  }
});

async function uploadFiles(files) {
  try {
    const folder = $("uploadFolder").value || "Default";
    const tagList = normalizeTags($("uploadTags").value);

    const arr = [...files].filter(f => f && f.type && f.type.startsWith("image/"));
    if (!arr.length) return setStatus("ไม่พบไฟล์รูปภาพ", "err");

    $("uploadMsg").textContent = `กำลังอัปโหลด ${arr.length} ไฟล์...`;
    setStatus(`กำลังอัปโหลด ${arr.length} ไฟล์...`);

    // ensure folder exists
    const ft = tx([STORE_FOLDERS], "readwrite");
    const fstore = ft.objectStore(STORE_FOLDERS);
    const exists = await idbGet(fstore, folder);
    if (!exists) await idbPut(fstore, { name: folder });
    await new Promise((res, rej) => { ft.oncomplete=res; ft.onerror=()=>rej(ft.error); });

    // add images
    const t = tx([STORE_IMAGES], "readwrite");
    const store = t.objectStore(STORE_IMAGES);

    for (const file of arr) {
      await idbAdd(store, {
        id: uid(),
        folder,
        name: file.name || "image",
        tags: tagList,
        createdAt: Date.now(),
        blob: file
      });
    }

    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    $("uploadMsg").textContent = `อัปโหลดสำเร็จ: ${arr.length} ไฟล์ → ${folder}`;
    setStatus(`อัปโหลดสำเร็จ: ${arr.length} ไฟล์ → ${folder}`, "ok");

    await renderFolderList();
    await updateUsageInfo();

    // If currently viewing this folder, refresh it
    if (currentFolder === folder) await renderFolderGallery(folder);
  } catch (e) {
    setStatus(`อัปโหลดไม่สำเร็จ: ${e?.message || e}`, "err");
    $("uploadMsg").textContent = `อัปโหลดไม่สำเร็จ: ${e?.message || e}`;
  }
}

/* Choose file */
$("btnChoose").addEventListener("click", () => {
  const fi = $("fileInput");
  fi.value = "";
  fi.click();
});
$("fileInput").addEventListener("change", (e) => {
  if (e.target.files && e.target.files.length) uploadFiles(e.target.files);
});

/* Drag & Drop */
const dz = $("dropzone");
dz.addEventListener("dragover", (e) => { e.preventDefault(); dz.classList.add("drag"); });
dz.addEventListener("dragleave", () => dz.classList.remove("drag"));
dz.addEventListener("drop", (e) => {
  e.preventDefault();
  dz.classList.remove("drag");
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
    uploadFiles(e.dataTransfer.files);
  }
});

/* Reset All */
$("btnResetAll").addEventListener("click", async () => {
  if (!confirm("ลบข้อมูลทั้งหมด (โฟลเดอร์+รูป) ในเครื่องนี้?")) return;
  try {
    const t = tx([STORE_IMAGES, STORE_FOLDERS], "readwrite");
    await idbClear(t.objectStore(STORE_IMAGES));
    await idbClear(t.objectStore(STORE_FOLDERS));
    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    await ensureDefaultFolder();
    await refillUploadFolderSelect();

    // back to folder list
    currentFolder = null;
    $("folderViewCard").classList.add("hidden");
    $("folderListCard").classList.remove("hidden");

    await renderFolderList();
    await updateUsageInfo();

    setStatus("รีเซ็ตเรียบร้อย", "ok");
  } catch (e) {
    setStatus(`รีเซ็ตไม่สำเร็จ: ${e?.message || e}`, "err");
  }
});

/* Top filters events */
$("filterFolderName").addEventListener("input", async () => {
  if (!currentFolder) await renderFolderList();
});
$("filterTags").addEventListener("input", async () => {
  if (!currentFolder) await renderFolderList();
});
$("btnClearFilters").addEventListener("click", async () => {
  $("filterFolderName").value = "";
  $("filterTags").value = "";
  if (!currentFolder) await renderFolderList();
});

/* Usage info (Upload tab) */
async function updateUsageInfo() {
  const folders = await listFolders();
  const stats = await getFolderStats();
  const total = Object.values(stats).reduce((s,x)=>s+(x.count||0),0);
  const el = $("usageInfo");
  if (el) el.textContent = `Folders: ${folders.length} • Images: ${total} • Storage: IndexedDB`;
}

/* Init */
(async function init(){
  try {
    setActiveTab("search"); // default
    setStatus("กำลังเปิดฐานข้อมูล IndexedDB...");
    db = await openDB();
    await ensureDefaultFolder();
    await refillUploadFolderSelect();
    await renderFolderList();
    await updateUsageInfo();
    setStatus("พร้อมใช้งาน ✅ (IndexedDB)", "ok");
  } catch (e) {
    // status may not be visible on search; switch to upload to show error
    setActiveTab("upload");
    setStatus(`เริ่มระบบไม่สำเร็จ: ${e?.message || e}\nแนะนำเปิดผ่าน https:// (GitHub Pages) ไม่ใช่ file://`, "err");
  }
})();
</script>
</body>
</html>
