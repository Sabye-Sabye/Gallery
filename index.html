<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pastel Gallery (IndexedDB)</title>

<style>
:root{
  --bg:#f6f8ff;
  --card:#ffffff;
  --text:#334155;
  --muted:#94a3b8;
  --line:#e5e7eb;

  /* Single pastel color */
  --accent:#93c5fd;        /* pastel blue */
  --accent-2:#bfdbfe;      /* lighter */
  --accent-text:#0b3a75;

  --radius:18px;
  --shadow: 0 10px 25px rgba(15, 23, 42, .08);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 450px at 12% 12%, rgba(147,197,253,.35), transparent 60%),
    radial-gradient(900px 450px at 88% 20%, rgba(191,219,254,.35), transparent 60%),
    var(--bg);
  color:var(--text);
}

.container{max-width:1100px;margin:24px auto;padding:0 16px}
h1{margin:0;font-size:28px}
h2{margin:0 0 10px;font-size:16px}
.muted{color:var(--muted)}
.small{font-size:12px}

.header{
  display:flex;align-items:flex-end;justify-content:space-between;
  gap:12px;flex-wrap:wrap;margin-bottom:10px
}

.tabs{display:flex;gap:8px}
.tab{
  user-select:none;
  padding:10px 18px;border-radius:999px;
  border:1px solid var(--line);
  background:rgba(255,255,255,.9);
  cursor:pointer;font-weight:900;
}
.tab.active{
  border:1px solid rgba(147,197,253,.65);
  background: rgba(147,197,253,.35);
  color: var(--accent-text);
}

.card{
  background:var(--card);
  border:1px solid rgba(148,163,184,.25);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow);
  margin:14px 0;
}

.row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
.field{display:flex;flex-direction:column;gap:6px;min-width:220px}
.field.grow{flex:1;min-width:260px}
label{font-size:12px;color:var(--muted)}

input,select{
  padding:12px 14px;border-radius:14px;
  border:1px solid var(--line);
  background:#fff;
  font-size:14px;
}

button{
  padding:12px 16px;border-radius:14px;border:1px solid rgba(147,197,253,.75);
  background: rgba(147,197,253,.35);
  color: var(--accent-text);
  font-weight:950;
  cursor:pointer;
}
button.secondary{
  background: rgba(191,219,254,.35);
  border:1px solid rgba(147,197,253,.55);
  color: var(--accent-text);
}
button.danger{
  background: rgba(147,197,253,.18);
  border:1px solid rgba(147,197,253,.55);
  color: #7a1d1d;
}
button:disabled{opacity:.6;cursor:not-allowed}

.panel.hidden{display:none}

/* Status box */
.status{
  border-radius:14px;
  border:1px solid rgba(147,197,253,.45);
  background: rgba(191,219,254,.18);
  padding:12px;
  white-space:pre-wrap;
}
.status.ok{border-color:rgba(34,197,94,.35); background:rgba(34,197,94,.08)}
.status.err{border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08)}

/* Folder view cards */
.foldersGrid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:14px;
}
.folderCard{
  border-radius:16px;
  overflow:hidden;
  background:#fff;
  border:1px solid var(--line);
  cursor:pointer;
  transition:transform .08s ease;
}
.folderCard:hover{transform:scale(1.01)}
.folderThumb{
  height:140px;
  background: rgba(191,219,254,.25);
  display:flex;align-items:center;justify-content:center;
  overflow:hidden;
}
.folderThumb img{width:100%;height:100%;object-fit:cover;display:block}
.folderThumb .ph{color:var(--muted);font-weight:900}
.folderMeta{
  padding:12px;
  display:flex;align-items:center;justify-content:space-between;gap:10px;
}
.folderName{font-weight:950;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.folderCount{
  font-size:12px;color:var(--muted);
  padding:4px 10px;border-radius:999px;border:1px solid var(--line);
  background:#f8fafc;
}
.folderRight{display:flex;gap:8px;align-items:center}

/* Dropzone */
.dropzone{
  margin-top:12px;
  padding:22px;
  border-radius:18px;
  border:2px dashed rgba(147,197,253,.85);
  text-align:center;
  background: rgba(191,219,254,.18);
}
.dropzone.drag{
  background: rgba(147,197,253,.18);
  border-color: rgba(96,165,250,.95);
}

/* Gallery */
.gallery{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
  gap:14px;margin-top:12px;
}
.thumb{
  border-radius:16px;
  overflow:hidden;
  background:#fff;
  border:1px solid var(--line);
}
.thumb img{width:100%;height:160px;object-fit:cover;display:block}
.meta{padding:12px;display:flex;flex-direction:column;gap:8px}
.metaTop{display:flex;justify-content:space-between;gap:10px;align-items:center}
.fileName{font-weight:950;font-size:13px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.badge{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background:#f8fafc;
  color:var(--muted);
  white-space:nowrap;
}
.tags{display:flex;gap:6px;flex-wrap:wrap}
.tag{
  font-size:11px;padding:4px 10px;border-radius:999px;
  background: rgba(191,219,254,.35);
  border:1px solid rgba(147,197,253,.55);
  color: var(--accent-text);
}
.actions{display:flex;gap:8px}
.actions a, .actions button{
  flex:1;
  text-align:center;
  padding:10px;
  border-radius:12px;
  border:1px solid rgba(147,197,253,.55);
  background: rgba(191,219,254,.25);
  color: var(--accent-text);
  font-weight:950;
  text-decoration:none;
}
.actions button{cursor:pointer}
</style>
</head>

<body>
<div class="container">

  <header class="header">
    <div>
      <h1>Pastel Gallery</h1>
      <div class="muted small">IndexedDB • เก็บรูปเยอะขึ้นมาก • ทำงานบน GitHub Pages ได้</div>
    </div>

    <div class="tabs">
      <div class="tab active" id="tabSearch" role="button" tabindex="0">Search</div>
      <div class="tab" id="tabUpload" role="button" tabindex="0">Upload</div>
    </div>
  </header>

  <section class="card">
    <h2>Status</h2>
    <div id="statusBox" class="status">กำลังเริ่มระบบ...</div>
    <div class="muted small" id="usageInfo">—</div>
  </section>

  <!-- Folder View -->
  <section class="card" id="folderViewCard">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h2 style="margin:0">Folders</h2>
      <div class="row" style="margin:0">
        <button class="secondary" id="btnShowAll">Show All</button>
        <button class="danger" id="btnResetAll" title="ลบข้อมูลทั้งหมดในเครื่องนี้">Reset All</button>
      </div>
    </div>

    <div id="foldersGrid" class="foldersGrid"></div>
    <div id="foldersEmpty" class="muted">ยังไม่มีโฟลเดอร์ — ไปที่แท็บ Upload เพื่อสร้างโฟลเดอร์</div>
  </section>

  <!-- Search -->
  <section class="panel" id="panelSearch">
    <div class="card">
      <h2>ค้นหา / ฟิลเตอร์</h2>
      <div class="row">
        <div class="field">
          <label>Folder</label>
          <select id="searchFolder"></select>
        </div>
        <div class="field grow">
          <label>Search (ชื่อไฟล์)</label>
          <input id="searchText" placeholder="เช่น trip, dc2, run..." />
        </div>
        <div class="field grow">
          <label>Tags (คั่นด้วย , )</label>
          <input id="searchTags" placeholder="hokkaido, snow, dc2" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="secondary" id="btnClearSearch">Clear</button>
        </div>
      </div>
      <div class="muted small" id="resultInfo">—</div>
    </div>
  </section>

  <!-- Upload -->
  <section class="panel hidden" id="panelUpload">
    <div class="card">
      <h2>สร้างโฟลเดอร์</h2>
      <div class="row">
        <div class="field grow">
          <label>New folder name</label>
          <input id="newFolderName" placeholder="เช่น Trip-Hokkaido / DC2 / Running" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button id="btnCreateFolder">Create</button>
        </div>
      </div>
      <div class="muted small">* Default ลบไม่ได้</div>
    </div>

    <div class="card">
      <h2>อัปโหลดรูป</h2>
      <div class="row">
        <div class="field">
          <label>Upload folder</label>
          <select id="uploadFolder"></select>
        </div>
        <div class="field grow">
          <label>Tags (ใช้กับรูปที่อัปโหลดรอบนี้)</label>
          <input id="uploadTags" placeholder="invoice, snow, family (คั่นด้วย , )" />
        </div>
        <div class="field">
          <label>&nbsp;</label>
          <button class="secondary" id="btnChoose">Choose images</button>
          <input type="file" id="fileInput" accept="image/*" multiple hidden />
        </div>
      </div>

      <div id="dropzone" class="dropzone">
        <div style="font-weight:950">ลากไฟล์รูปมาวางที่นี่ (Drag & Drop)</div>
        <div class="muted small">iPhone อาจไม่รองรับ Drag&Drop → ใช้ Choose images</div>
      </div>

      <div class="muted small" id="uploadMsg">—</div>
    </div>
  </section>

  <!-- Gallery -->
  <section class="card">
    <h2>Gallery</h2>
    <div id="gallery" class="gallery"></div>
    <div id="emptyState" class="muted">ยังไม่มีรูป — ไปที่แท็บ Upload เพื่อเพิ่มรูป</div>
  </section>

</div>

<script>
/* =========================================================
   IndexedDB Data Model
   - DB: gallery_db_v1
   - stores:
     1) folders: { name (key) }
     2) images: { id (key), folder, name, tags[], createdAt, blob }
     Indexes: images.by_folder, images.by_createdAt
========================================================= */
const DB_NAME = "gallery_db_v1";
const DB_VERSION = 1;

const STORE_FOLDERS = "folders";
const STORE_IMAGES = "images";

const $ = (id) => document.getElementById(id);

function setStatus(msg, type="") {
  const box = $("statusBox");
  box.className = "status" + (type ? " " + type : "");
  box.textContent = msg;
  console.log("[STATUS]", msg);
}

function uid() {
  return Date.now().toString(16) + "_" + Math.random().toString(16).slice(2);
}

function normalizeTags(str) {
  return String(str || "")
    .split(",")
    .map(t => t.trim())
    .filter(Boolean)
    .map(t => t.toLowerCase());
}

function sanitizeFolderName(name) {
  return String(name || "")
    .trim()
    .replace(/[\/\\]/g, "-")
    .replace(/(\.\.)/g, "")
    .replace(/[^\wก-๙\s.-]/g, "")
    .trim();
}

let db;

/* -------------------------
   IndexedDB helpers
------------------------- */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onerror = () => reject(req.error);
    req.onupgradeneeded = () => {
      const d = req.result;

      if (!d.objectStoreNames.contains(STORE_FOLDERS)) {
        d.createObjectStore(STORE_FOLDERS, { keyPath: "name" });
      }

      if (!d.objectStoreNames.contains(STORE_IMAGES)) {
        const s = d.createObjectStore(STORE_IMAGES, { keyPath: "id" });
        s.createIndex("by_folder", "folder", { unique: false });
        s.createIndex("by_createdAt", "createdAt", { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
  });
}

function tx(storeNames, mode="readonly") {
  return db.transaction(storeNames, mode);
}

function idbPut(store, value) {
  return new Promise((resolve, reject) => {
    const r = store.put(value);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
function idbAdd(store, value) {
  return new Promise((resolve, reject) => {
    const r = store.add(value);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
function idbGet(store, key) {
  return new Promise((resolve, reject) => {
    const r = store.get(key);
    r.onsuccess = () => resolve(r.result);
    r.onerror = () => reject(r.error);
  });
}
function idbDel(store, key) {
  return new Promise((resolve, reject) => {
    const r = store.delete(key);
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}
function idbGetAll(store) {
  return new Promise((resolve, reject) => {
    const r = store.getAll();
    r.onsuccess = () => resolve(r.result || []);
    r.onerror = () => reject(r.error);
  });
}
function idbClear(store) {
  return new Promise((resolve, reject) => {
    const r = store.clear();
    r.onsuccess = () => resolve();
    r.onerror = () => reject(r.error);
  });
}

/* get images by folder index */
function idbGetAllByIndex(index, key) {
  return new Promise((resolve, reject) => {
    const r = index.getAll(key);
    r.onsuccess = () => resolve(r.result || []);
    r.onerror = () => reject(r.error);
  });
}

/* delete all images in a folder */
async function deleteImagesInFolder(folder) {
  const t = tx([STORE_IMAGES], "readwrite");
  const store = t.objectStore(STORE_IMAGES);
  const idx = store.index("by_folder");
  const images = await idbGetAllByIndex(idx, folder);
  for (const img of images) await idbDel(store, img.id);
  await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });
}

/* count images per folder + latest cover */
async function getFolderStats() {
  const folders = await listFolders();
  const stats = {};
  for (const f of folders) stats[f] = { count: 0, coverId: null, coverCreatedAt: 0 };

  // scan all images once (ok for moderate size; can optimize later)
  const t = tx([STORE_IMAGES], "readonly");
  const store = t.objectStore(STORE_IMAGES);
  const all = await idbGetAll(store);

  for (const img of all) {
    if (!stats[img.folder]) stats[img.folder] = { count: 0, coverId: null, coverCreatedAt: 0 };
    stats[img.folder].count++;
    if ((img.createdAt||0) > (stats[img.folder].coverCreatedAt||0)) {
      stats[img.folder].coverCreatedAt = img.createdAt||0;
      stats[img.folder].coverId = img.id;
    }
  }
  return stats;
}

async function listFolders() {
  const t = tx([STORE_FOLDERS], "readonly");
  const store = t.objectStore(STORE_FOLDERS);
  const all = await idbGetAll(store);
  const names = all.map(x => x.name).sort((a,b)=>a.localeCompare(b));
  return names;
}

async function ensureDefaultFolder() {
  const t = tx([STORE_FOLDERS], "readwrite");
  const store = t.objectStore(STORE_FOLDERS);
  const existing = await idbGet(store, "Default");
  if (!existing) await idbPut(store, { name: "Default" });
  await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });
}

/* -------------------------
   Tabs
------------------------- */
function setActiveTab(tab) {
  const isSearch = tab === "search";
  $("tabSearch").classList.toggle("active", isSearch);
  $("tabUpload").classList.toggle("active", !isSearch);
  $("panelSearch").classList.toggle("hidden", !isSearch);
  $("panelUpload").classList.toggle("hidden", isSearch);
}
$("tabSearch").addEventListener("click", () => setActiveTab("search"));
$("tabUpload").addEventListener("click", () => setActiveTab("upload"));

/* -------------------------
   UI: fill selects
------------------------- */
async function refillFolderSelects() {
  const folders = await listFolders();

  const up = $("uploadFolder");
  up.innerHTML = "";
  folders.forEach(f => {
    const o=document.createElement("option");
    o.value=f; o.textContent=f;
    up.appendChild(o);
  });
  if (!up.value && folders.length) up.value = folders[0];

  const sf = $("searchFolder");
  const current = sf.value;
  sf.innerHTML = "";
  const allOpt = document.createElement("option");
  allOpt.value="__ALL__";
  allOpt.textContent="All folders";
  sf.appendChild(allOpt);

  folders.forEach(f => {
    const o=document.createElement("option");
    o.value=f; o.textContent=f;
    sf.appendChild(o);
  });

  if ([...sf.options].some(o=>o.value===current)) sf.value=current;
  else sf.value="__ALL__";
}

/* -------------------------
   Render folders with cover preview
------------------------- */
async function blobToObjectURL(blob) {
  return URL.createObjectURL(blob);
}

async function renderFolders() {
  const grid = $("foldersGrid");
  const empty = $("foldersEmpty");
  grid.innerHTML = "";

  const folders = await listFolders();
  if (!folders.length) {
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  const stats = await getFolderStats();

  for (const f of folders) {
    const count = stats[f]?.count ?? 0;
    const coverId = stats[f]?.coverId ?? null;

    const card = document.createElement("div");
    card.className = "folderCard";

    const thumb = document.createElement("div");
    thumb.className = "folderThumb";

    if (coverId) {
      const t = tx([STORE_IMAGES], "readonly");
      const store = t.objectStore(STORE_IMAGES);
      const cover = await idbGet(store, coverId);
      if (cover?.blob) {
        const img = document.createElement("img");
        img.loading = "lazy";
        img.alt = f;
        img.src = await blobToObjectURL(cover.blob);
        thumb.appendChild(img);
        img.onload = () => URL.revokeObjectURL(img.src);
      } else {
        const ph = document.createElement("div");
        ph.className = "ph";
        ph.textContent = "No image";
        thumb.appendChild(ph);
      }
    } else {
      const ph = document.createElement("div");
      ph.className = "ph";
      ph.textContent = "No image";
      thumb.appendChild(ph);
    }

    const meta = document.createElement("div");
    meta.className = "folderMeta";

    const name = document.createElement("div");
    name.className = "folderName";
    name.textContent = f;
    name.title = f;

    const right = document.createElement("div");
    right.className = "folderRight";

    const badge = document.createElement("div");
    badge.className = "folderCount";
    badge.textContent = `${count}`;

    const del = document.createElement("button");
    del.className = "danger";
    del.style.padding = "8px 10px";
    del.style.borderRadius = "12px";
    del.style.fontSize = "12px";
    del.textContent = "Delete";
    del.addEventListener("click", (e) => {
      e.stopPropagation();
      deleteFolder(f);
    });

    right.appendChild(badge);
    right.appendChild(del);

    meta.appendChild(name);
    meta.appendChild(right);

    card.appendChild(thumb);
    card.appendChild(meta);

    card.addEventListener("click", async () => {
      $("searchFolder").value = f;
      $("searchText").value = "";
      $("searchTags").value = "";
      setActiveTab("search");
      await renderGallery();
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    });

    grid.appendChild(card);
  }
}

/* -------------------------
   Folder create / delete
------------------------- */
$("btnCreateFolder").addEventListener("click", async () => {
  try {
    const name = sanitizeFolderName($("newFolderName").value);
    if (!name) return setStatus("กรุณาใส่ชื่อโฟลเดอร์", "err");

    const folders = await listFolders();
    if (folders.includes(name)) return setStatus("มีโฟลเดอร์นี้อยู่แล้ว", "err");

    const t = tx([STORE_FOLDERS], "readwrite");
    const store = t.objectStore(STORE_FOLDERS);
    await idbPut(store, { name });

    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    $("newFolderName").value = "";
    await refillFolderSelects();
    await renderFolders();
    setStatus(`สร้างโฟลเดอร์สำเร็จ: ${name}`, "ok");
    setActiveTab("upload");
    $("uploadFolder").value = name;
  } catch (e) {
    setStatus(`สร้างโฟลเดอร์ไม่สำเร็จ: ${e?.message || e}`, "err");
  }
});

async function deleteFolder(folder) {
  if (folder === "Default") {
    alert('ไม่อนุญาตให้ลบโฟลเดอร์ "Default"');
    return;
  }
  if (!confirm(`ลบโฟลเดอร์ "${folder}" และรูปทั้งหมดในโฟลเดอร์นี้?`)) return;

  try {
    await deleteImagesInFolder(folder);

    const t = tx([STORE_FOLDERS], "readwrite");
    const store = t.objectStore(STORE_FOLDERS);
    await idbDel(store, folder);
    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    await refillFolderSelects();
    await renderFolders();
    await renderGallery();
    setStatus(`ลบโฟลเดอร์ "${folder}" แล้ว`, "ok");
  } catch (e) {
    setStatus(`ลบโฟลเดอร์ไม่สำเร็จ: ${e?.message || e}`, "err");
  }
}

/* -------------------------
   Upload images to IndexedDB
   - store as Blob to save space
------------------------- */
async function uploadFiles(files) {
  try {
    const folder = $("uploadFolder").value || "Default";
    const tagList = normalizeTags($("uploadTags").value);

    const arr = [...files].filter(f => f && f.type && f.type.startsWith("image/"));
    if (!arr.length) return setStatus("ไม่พบไฟล์รูปภาพ", "err");

    $("uploadMsg").textContent = `กำลังอัปโหลด ${arr.length} ไฟล์...`;
    setStatus(`กำลังอัปโหลด ${arr.length} ไฟล์...`);

    // Ensure folder exists
    const ft = tx([STORE_FOLDERS], "readwrite");
    const fstore = ft.objectStore(STORE_FOLDERS);
    const fexists = await idbGet(fstore, folder);
    if (!fexists) await idbPut(fstore, { name: folder });
    await new Promise((res, rej) => { ft.oncomplete=res; ft.onerror=()=>rej(ft.error); });

    // Add images
    const t = tx([STORE_IMAGES], "readwrite");
    const store = t.objectStore(STORE_IMAGES);

    for (const file of arr) {
      const record = {
        id: uid(),
        folder,
        name: file.name || "image",
        tags: tagList,
        createdAt: Date.now(),
        blob: file // store original blob (efficient)
      };
      await idbAdd(store, record);
    }

    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    $("uploadMsg").textContent = `อัปโหลดสำเร็จ: ${arr.length} ไฟล์ → ${folder}`;
    setStatus(`อัปโหลดสำเร็จ: ${arr.length} ไฟล์ → ${folder}`, "ok");

    await refillFolderSelects();
    await renderFolders();
    await renderGallery();
  } catch (e) {
    setStatus(`อัปโหลดไม่สำเร็จ: ${e?.message || e}`, "err");
    $("uploadMsg").textContent = `อัปโหลดไม่สำเร็จ: ${e?.message || e}`;
  }
}

/* Choose file */
$("btnChoose").addEventListener("click", () => {
  const fi = $("fileInput");
  fi.value = "";
  fi.click();
});
$("fileInput").addEventListener("change", (e) => {
  if (e.target.files && e.target.files.length) uploadFiles(e.target.files);
});

/* Drag & Drop (desktop) */
const dz = $("dropzone");
dz.addEventListener("dragover", (e) => { e.preventDefault(); dz.classList.add("drag"); });
dz.addEventListener("dragleave", () => dz.classList.remove("drag"));
dz.addEventListener("drop", (e) => {
  e.preventDefault();
  dz.classList.remove("drag");
  if (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) {
    uploadFiles(e.dataTransfer.files);
  }
});

/* -------------------------
   Search + Gallery + delete image
------------------------- */
function matchAllTags(imgTags, wantTags) {
  const set = new Set((imgTags || []).map(t => String(t).toLowerCase()));
  for (const t of wantTags) if (!set.has(t)) return false;
  return true;
}

async function getAllImages() {
  const t = tx([STORE_IMAGES], "readonly");
  const store = t.objectStore(STORE_IMAGES);
  const all = await idbGetAll(store);
  all.sort((a,b)=>(b.createdAt||0)-(a.createdAt||0));
  return all;
}

async function renderGallery() {
  const gallery = $("gallery");
  const empty = $("emptyState");
  const info = $("resultInfo");

  gallery.innerHTML = "";

  const folder = $("searchFolder").value;
  const text = ($("searchText").value || "").trim().toLowerCase();
  const wantTags = normalizeTags($("searchTags").value);

  const all = await getAllImages();
  const filtered = all.filter(img => {
    if (folder !== "__ALL__" && img.folder !== folder) return false;
    if (text && !(img.name || "").toLowerCase().includes(text)) return false;
    if (wantTags.length && !matchAllTags(img.tags, wantTags)) return false;
    return true;
  });

  if (!filtered.length) {
    empty.style.display = "block";
    info.textContent = all.length ? "ไม่พบรูปตามเงื่อนไข" : "—";
    return;
  }
  empty.style.display = "none";
  info.textContent = `แสดง ${filtered.length} จากทั้งหมด ${all.length} รูป`;

  for (const img of filtered) {
    const card = document.createElement("div");
    card.className = "thumb";

    const imageEl = document.createElement("img");
    imageEl.alt = img.name || "image";
    imageEl.loading = "lazy";
    const url = URL.createObjectURL(img.blob);
    imageEl.src = url;
    imageEl.onload = () => URL.revokeObjectURL(url);

    const meta = document.createElement("div");
    meta.className = "meta";

    const top = document.createElement("div");
    top.className = "metaTop";

    const name = document.createElement("div");
    name.className = "fileName";
    name.textContent = img.name || "(no name)";
    name.title = img.name || "";

    const badge = document.createElement("div");
    badge.className = "badge";
    badge.textContent = img.folder;

    top.appendChild(name);
    top.appendChild(badge);

    const tagsWrap = document.createElement("div");
    tagsWrap.className = "tags";
    (img.tags || []).forEach(t => {
      const tag = document.createElement("span");
      tag.className = "tag";
      tag.textContent = t;
      tag.addEventListener("click", async () => {
        const current = new Set(normalizeTags($("searchTags").value));
        current.add(String(t).toLowerCase());
        $("searchTags").value = Array.from(current).join(", ");
        setActiveTab("search");
        await renderGallery();
      });
      tagsWrap.appendChild(tag);
    });

    const actions = document.createElement("div");
    actions.className = "actions";

    // Download: create blob URL at click time
    const dl = document.createElement("a");
    dl.href = "#";
    dl.textContent = "Download";
    dl.addEventListener("click", (e) => {
      e.preventDefault();
      const u = URL.createObjectURL(img.blob);
      const a = document.createElement("a");
      a.href = u;
      a.download = img.name || "image";
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(u), 1000);
    });

    const del = document.createElement("button");
    del.textContent = "Delete";
    del.addEventListener("click", async () => {
      if (!confirm("ลบรูปนี้ออกจากเครื่องนี้?")) return;
      try {
        const t = tx([STORE_IMAGES], "readwrite");
        const store = t.objectStore(STORE_IMAGES);
        await idbDel(store, img.id);
        await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });
        setStatus("ลบรูปแล้ว", "ok");
        await renderFolders();
        await renderGallery();
      } catch (e) {
        setStatus(`ลบรูปไม่สำเร็จ: ${e?.message || e}`, "err");
      }
    });

    actions.appendChild(dl);
    actions.appendChild(del);

    meta.appendChild(top);
    if ((img.tags || []).length) meta.appendChild(tagsWrap);
    meta.appendChild(actions);

    card.appendChild(imageEl);
    card.appendChild(meta);
    gallery.appendChild(card);
  }
}

/* Search events */
$("searchFolder").addEventListener("change", renderGallery);
$("searchText").addEventListener("input", renderGallery);
$("searchTags").addEventListener("input", renderGallery);

$("btnClearSearch").addEventListener("click", async () => {
  $("searchFolder").value="__ALL__";
  $("searchText").value="";
  $("searchTags").value="";
  await renderGallery();
  setStatus("ล้างฟิลเตอร์แล้ว", "ok");
});

$("btnShowAll").addEventListener("click", async () => {
  $("searchFolder").value="__ALL__";
  $("searchText").value="";
  $("searchTags").value="";
  setActiveTab("search");
  await renderGallery();
  setStatus("แสดงรูปทั้งหมดแล้ว", "ok");
});

/* Reset all */
$("btnResetAll").addEventListener("click", async () => {
  if (!confirm("ลบข้อมูลทั้งหมด (โฟลเดอร์+รูป) ในเครื่องนี้?")) return;
  try {
    const t = tx([STORE_IMAGES, STORE_FOLDERS], "readwrite");
    await idbClear(t.objectStore(STORE_IMAGES));
    await idbClear(t.objectStore(STORE_FOLDERS));
    await new Promise((res, rej) => { t.oncomplete=res; t.onerror=()=>rej(t.error); });

    await ensureDefaultFolder();
    await refillFolderSelects();
    await renderFolders();
    await renderGallery();
    setStatus("รีเซ็ตเรียบร้อย", "ok");
  } catch (e) {
    setStatus(`รีเซ็ตไม่สำเร็จ: ${e?.message || e}`, "err");
  }
});

/* Usage info */
async function updateUsageInfo() {
  // basic counts only (fast)
  const folders = await listFolders();
  const stats = await getFolderStats();
  const total = Object.values(stats).reduce((s,x)=>s+(x.count||0),0);
  $("usageInfo").textContent = `Folders: ${folders.length} • Images: ${total} • Storage: IndexedDB`;
}

/* Init */
(async function init(){
  try {
    setStatus("กำลังเปิดฐานข้อมูล IndexedDB...");
    db = await openDB();
    await ensureDefaultFolder();
    await refillFolderSelects();
    await renderFolders();
    await renderGallery();
    await updateUsageInfo();
    setActiveTab("search");
    setStatus("พร้อมใช้งาน ✅ (IndexedDB)", "ok");
  } catch (e) {
    setStatus(`เริ่มระบบไม่สำเร็จ: ${e?.message || e}\nลองเปิดผ่าน https:// (GitHub Pages) ไม่ใช่ file://`, "err");
  }
})();
</script>
</body>
</html>
